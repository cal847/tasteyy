{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'recipes/css/recipe_list.css' %}">
<link rel="stylesheet" href="{% static 'recipes/css/recipe-details.css' %}">
{% endblock %}

{% block content %}
<div class="details-container">
    <div class="details-header">
        {% if recipe.image %}
            <img src="{{recipe.image.url}}" alt="{{ recipe.title }}">
        {% elif recipe.image_url %}
            <img src="{{recipe.image_url}}" alt="{{ recipe.title }}">
        {% else %}
            <img src="{% static 'recipes/images/default.png' %}" alt="{{ recipe.title }}">
        {% endif %}

        <h1> {{ recipe.title }}</h1>
    </div>

    <div class="details-wrapper">
        <div class="rating-container">
            <div class="star-rating" data-rating="{{ recipe.avg_rating|default:0 }}">
                {% include "recipes/_star.html" %}
                {% include "recipes/_star.html" %}
                {% include "recipes/_star.html" %}
                {% include "recipes/_star.html" %}
                {% include "recipes/_star.html" %} 
            </div>        
            <p>({{ recipe.total_ratings }})</p>
        </div>
        <p> {{ recipe.display_category }}</p>
        <p> {{ recipe.cooking_time }} min</p>
        <p> {{ recipe.servings }} servings</p>
    </div>

    <!-- Diet bubbles section  -->
    <div class="diet-bubbles">
        {% if recipe.diet %}
            {% for diet_item in recipe.diet %}
                <div class="diet-bubble">{{ diet_item }}</div>
            {% endfor %}
        {% elif recipe.diet_type %}
            <div class="diet-bubble">{{ recipe.diet_type }}</div>
        {% endif %}
    </div>

    <div class="nutritional-value">
        <h1> Nutritional Values </h1>
        {% if nut_v %}
            <ol>
                <li>Calories: {{ nut_v.calories_kcal }} kcal</li>
                <li>Protein: {{ nut_v.protein }} g</li>
                <li>Fat: {{ nut_v.fat }} g</li>
                <li>Carbs: {{ nut_v.carbs }} g</li>
                <li>Fiber: {{ nut_v.fiber }} g</li>
                <li>Sugars: {{ nut_v.sugars }} g</li>
                <li>Sodium: {{ nut_v.sodium }} mg</li>
                <li>Cholesterol: {{ nut_v.cholesterol }} mg</li>
                <li>Calcium: {{ nut_v.calcium }} mg</li>
                <li>Iron: {{ nut_v.iron }} mg</li>
                <li>Vitamin C: {{ nut_v.vitamin_c }} mg</li>
            </ol>
        {% else %}
            <p>No nutritional value available</p>
        {% endif %}
    </div>
    
    <div class="wrapper rotating-bg" style="
            --bg1: url('{% static 'recipes/images/bg2.jpg' %}');
            --bg2: url('{% static 'recipes/images/bg3.jpg' %}');
            --bg3: url('{% static 'recipes/images/bg4.jpg' %}');
        ">
        <div class="recipe-grid"  >
            {% if recipe.description %}
            <div class="summary">
                <h1>Description</h1>
                <p> {{ recipe.description }}</p>            
            </div>
            {% endif %}

            <div class="ingredients">
                <h1> Ingredients </h1>
                {% if ingredients %}
                    <ol>
                        {% for ingredient in ingredients%}
                            <p>{{ ingredient }}</p>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p>Ingredients unavailable</p>
                {% endif %}
            </div>

            <div class="tips">
                {% if recipe.tips %}
                    <h1>Extra Tips</h1>
                    <p> {{ recipe.tips }}</p>
                {% else %}
                    <h1>Extra Tips</h1>
                    <p>No additional tips available for this recipe.</p>
                {% endif %}          
            </div>
            
            <div class="instructions">
                <h1> Instructions </h1>
                {% if instructions %}
                    <ol >
                        {% for instruction in instructions%}
                            <p>{{ instruction }}</p>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p>Instructions unavailable</p>
                {% endif %}
            </div>
        </div>
        <div class="cr-wrapper">
            <!-- Comments Section -->
            <div class="comments">
                <h1>Comments</h1>
                <div id="comment-list">
                    {% for comment in comments %}
                        {% include "recipes/_comment.html" with comment=comment %}
                    {% empty %}
                        <p>Be the first to comment!!</p>
                    {% endfor %}
                </div>
                    <form id="comment-form"
                    data-url="{% url 'recipes:add_comment' recipe.slug %}"
                    method="post"
                    {% if not user.is_authenticated %}data-guest="true"{%endif%}
                    >
                        {% csrf_token %}
                        {{ comment_form.content }}
                        {{ comment_form.non_field_errors }}
                        <input type="hidden" id="comment-parent-id" name="parent" value="">
                        <button type="submit" class="btn-comment"><i class="fa-solid fa-paper-plane"></i></button>
                    </form>
            </div>
            <!-- Authentication Required Modal -->
            <div id="auth-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>Authentication Required</h3>
                    <p>You need to be logged in to comment.</p>
                    <a href="{% url 'accounts:login' %}" class="btn-login">Log In</a>
                </div>
            </div>
                
            <!-- Ratings Section -->
            <div class="ratings">
                <h1>Ratings</h1>
                
                <!-- Star-based rating input (supports -5 to +5) -->
                <div class="star-rating-input" data-rating="0">
                    <!-- We'll generate 11 "star" slots: -5 to +5 -->
                    <!-- But visually, we'll show them as a single row with color logic -->
                    <div class="star negative" data-value="-5"></div>
                    <div class="star negative" data-value="-4"></div>
                    <div class="star negative" data-value="-3"></div>
                    <div class="star negative" data-value="-2"></div>
                    <div class="star negative" data-value="-1"></div>
                    <div class="star neutral" data-value="0"></div>
                    <div class="star positive" data-value="1"></div>
                    <div class="star positive" data-value="2"></div>
                    <div class="star positive" data-value="3"></div>
                    <div class="star positive" data-value="4"></div>
                    <div class="star positive" data-value="5"></div>
                </div>

                <!-- Hidden input for form submission -->
                <input type="hidden" name="rating" id="rating-input" value="0">
                
                <!-- Optional: show live numeric value -->
                <div class="rating-value-display">
                    Rating: <span id="live-rating">0.0</span>
                </div>

                <button type="submit" id="submit-rating-btn">Submit Rating</button>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'recipes/js/recipes.js' %}"></script>
{% endblock %}