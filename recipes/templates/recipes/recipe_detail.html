{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'recipes/css/recipe_list.css' %}">
<link rel="stylesheet" href="{% static 'recipes/css/recipe-details.css' %}">
{% endblock %}

{% block content %}
<div class="details-container">
    <div class="details-header">
        {% if recipe.image %}
            <img src="{{recipe.image.url}}" alt="{{ recipe.title }}">
        {% elif recipe.image_url %}
            <img src="{{recipe.image_url}}" alt="{{ recipe.title }}">
        {% else %}
            <img src="{% static 'recipes/images/default.png' %}" alt="{{ recipe.title }}">
        {% endif %}

        <h1> {{ recipe.title }}</h1>
    </div>

    <div class="details-wrapper">
        <div class="rating-container">
            {% if recipe.avg_rating %}
                <div class="star-rating" data-rating="{{ recipe.avg_rating }}">
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                </div>
                <span class="rating-text">({{ recipe.avg_rating|floatformat:1 }})</span>
            {% else %}
                <div class="star-rating" data-rating="0">
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="star">
                        <svg class="star-outline" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                        <svg class="star-fill" viewBox="0 0 24 24">
                            <path d="M12,2L15.09,8.26L22,9.27L17,14.14L18.18,21.02L12,17.77L5.82,21.02L7,14.14L2,9.27L8.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                </div>
            {% endif %}
            <p>({{ recipe.total_ratings }})</p>
        </div>
        <p> {{ recipe.display_category }}</p>
        <p> {{ recipe.cooking_time }} min</p>
        <p> {{ recipe.servings }} servings</p>
    </div>

    <!-- Diet bubbles section  -->
    <div class="diet-bubbles">
        {% if recipe.diet %}
            {% for diet_item in recipe.diet %}
                <div class="diet-bubble">{{ diet_item }}</div>
            {% endfor %}
        {% elif recipe.diet_type %}
            <div class="diet-bubble">{{ recipe.diet_type }}</div>
        {% endif %}
    </div>

    <div class="nutritional-value">
        <h1> Nutritional Values </h1>
        {% if nut_v %}
            <ol>
                <li>Calories: {{ nut_v.calories_kcal }} kcal</li>
                <li>Protein: {{ nut_v.protein }} g</li>
                <li>Fat: {{ nut_v.fat }} g</li>
                <li>Carbs: {{ nut_v.carbs }} g</li>
                <li>Fiber: {{ nut_v.fiber }} g</li>
                <li>Sugars: {{ nut_v.sugars }} g</li>
                <li>Sodium: {{ nut_v.sodium }} mg</li>
                <li>Cholesterol: {{ nut_v.cholesterol }} mg</li>
                <li>Calcium: {{ nut_v.calcium }} mg</li>
                <li>Iron: {{ nut_v.iron }} mg</li>
                <li>Vitamin C: {{ nut_v.vitamin_c }} mg</li>
            </ol>
        {% else %}
            <p>No nutritional value available</p>
        {% endif %}
    </div>
    
    <div class="wrapper rotating-bg" style="
            --bg1: url('{% static 'recipes/images/bg2.jpg' %}');
            --bg2: url('{% static 'recipes/images/bg3.jpg' %}');
            --bg3: url('{% static 'recipes/images/bg4.jpg' %}');
        ">
        <div class="recipe-grid"  >
            {% if recipe.description %}
            <div class="summary">
                <h1>Description</h1>
                <p> {{ recipe.description }}</p>            
            </div>
            {% endif %}

            <div class="ingredients">
                <h1> Ingredients </h1>
                {% if ingredients %}
                    <ol>
                        {% for ingredient in ingredients%}
                            <p>{{ ingredient }}</p>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p>Ingredients unavailable</p>
                {% endif %}
            </div>

            <div class="tips">
                {% if recipe.tips %}
                    <h1>Extra Tips</h1>
                    <p> {{ recipe.tips }}</p>
                {% else %}
                    <h1>Extra Tips</h1>
                    <p>No additional tips available for this recipe.</p>
                {% endif %}          
            </div>
            
            <div class="instructions">
                <h1> Instructions </h1>
                {% if instructions %}
                    <ol >
                        {% for instruction in instructions%}
                            <p>{{ instruction }}</p>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p>Instructions unavailable</p>
                {% endif %}
            </div>
        </div>
        <div class="cr-wrapper">
            <!-- Comments Section -->
            <div class="comments">
                <h1>Comments</h1>
                <div id="comment-list">
                    {% for comment in comments %}
                        {% include "recipes/_comment.html" with comment=comment %}
                    {% empty %}
                        <p>Be the first to comment!!</p>
                    {% endfor %}
                </div>
                <form id="comment-form" data-url="{% url 'recipes:add_comment' recipe.slug %}" method="post">
                    {% csrf_token %}
                    {{ comment_form.content }}
                    {{ comment_form.non_field_errors }}
                    <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </div>
                
            <!-- Ratings Section -->
            <div class="ratings">
                <h1>Ratings</h1>
            </div>
        </div>
    </div>
</div>
<script>
    // Initialize star ratings when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const starRatings = document.querySelectorAll('.star-rating');
        
        starRatings.forEach(container => {
            const rating = parseFloat(container.getAttribute('data-rating')) || 0;
            const stars = container.querySelectorAll('.star');
            
            stars.forEach((star, index) => {
                const starNumber = index + 1;
                const fillElement = star.querySelector('.star-fill');
                
                if (rating >= starNumber) {
                    // Full star
                    fillElement.style.clipPath = 'inset(0 0% 0 0)';
                } else if (rating > starNumber - 1) {
                    // Partial star
                    const fillPercentage = (rating - (starNumber - 1)) * 100;
                    fillElement.style.clipPath = `inset(0 ${100 - fillPercentage}% 0 0)`;
                } else {
                    // Empty star
                    fillElement.style.clipPath = 'inset(0 100% 0 0)';
                }
            });
        });

        // AJAX to prevent page refresh when a comment is added
        const commentForm = document.getElementById("comment-form");
        if (commentForm) {
            commentForm.addEventListener("submit", function (e) {
                e.preventDefault();
                postForm(commentForm, "#comment-list", true);
            });
        }

        // Handle reply forms
        document.body.addEventListener("submit", function (e) {
            if (e.target.classList.contains("reply-form")) {
                e.preventDefault();
                const form = e.target;
                const repliesDiv = form.closest(".comment").querySelector(".replies");
                postForm(form, repliesDiv, false);
            }
        });

        // Toggle reply form
        document.body.addEventListener("click", function (e) {
            if (e.target.classList.contains("reply-toggle")) {
                const form = e.target.parentElement.querySelector(".reply-form");
                form.style.display = form.style.display === "none" ? "block" : "none";
            }
        });

        function postForm(form, targetSelector, prepend) {
            const url = form.dataset.url;
            const data = new FormData(form);

            fetch(url, {
                method: "POST",
                headers: {"X-CSRFToken": data.get("csrfmiddlewaretoken")},
                body: data,
            })
            .then(res => res.json())
            .then(json => {
                if (json.success) {
                    if (prepend) {
                        document.querySelector(targetSelector).insertAdjacentHTML("afterbegin", json.html);
                    } else {
                        targetSelector.insertAdjacentHTML("beforeend", json.html);
                    }
                    form.reset();

                    // Only hide reply forms, not the main form
                    if (form.classList.contains("reply-form")) {
                        form.style.display = "none";
                    }
                    
                }
            })
            .catch(err => console.error(err));
        }

    });
</script>

{% endblock %}